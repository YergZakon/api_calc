SUPPORTED_LANGS = {"ru"}


def normalize_lang(lang: str) -> str:
    if not lang:
        return "ru"
    lang = lang.lower().strip()
    return "ru" if lang not in SUPPORTED_LANGS else lang


# Minimal UserDict mapping extracted from count_srk.prg comments (RU only).
_USER_DICT_RU: dict[int, str] = {
    5265: "Не предусмотрено",
    5266: "Не назначается (ч.2 ст.42 УК РК)",
    5267: "Не назначается (ч.3 ст.81 УК РК) отсутствие дохода у н/летнего",
    5268: "Не назначается (ч.4 ст.81 УК РК) отсутствие дохода у н/летнего",
    5269: "Не назначается (ч.3 ст.43 УК РК)",
    5270: "Не назначается (ч.3 ст.45 УК РК)",
    5271: "Не назначается (ч.7 ст.81 УК РК)",
    5272: "Не назначается (ч.1 ст.55 УК РК)",
    5276: "Не назначается (ч.2 ст.47 УК РК)",
    5277: "Может быть назначена",
    5278: "Не назначается (ч.2 п.3 ст.55 УК РК)",
    5279: "пожизненное лишение свободы",
    5280: "Не назначается (ч.4 ст.56 УК РК)",
    5281: "Конфискация имущества обязательна",
    5282: "Возможна конфискация имущества",
    5283: "Несовершеннолетним конфискация имущества не назначается",
    5284: "Выдворение за пределы РК иностранца или лица без гражданства обязательно",
    5285: "Возможно выдворение за пределы РК иностранца или лица без гражданства",
    5286: "Несовершеннолетним выдворение за пределы РК иностранца или лица без гражданства не назначается",
    5287: "Лицо должно быть иностранцем или лицом без гражданства, т.к. по этой статье обязательно выдворение за пределы РК",
    5288: "Пожизненное лишение права занимать определенную должность или заниматься определенной деятельностью обязательно",
    5289: "Возможно назначение пожизненного лишения права занимать определенную должность или заниматься определенной деятельностью",
    5290: "Несовершеннолетним пожизненное лишение права занимать определенную должность или заниматься определенной деятельностью не назначается",
    5291: "Обязательно назначение лишения права занимать определенную должность или заниматься деятельностью сроком",
    5292: "Возможно назначение лишения права занимать определенную должность или заниматься деятельностью сроком",
    5293: "Лица, не достигшие ко времени совершения преступления четырнадцатилетнего возраста, не подлежат уголовной ответственности",
    5294: "Лица, не достигшие ко времени совершения преступления 16-ти летнего возраста, не подлежат уголовной ответственности за исключением случаев совершения преступлений, предусмотренных ч.2 ст.15 УК РК",
    5295: "Уголовная ответственность за \"приготовление\" к преступлению наступает только за приготовление к тяжкому или особо тяжкому преступлению, а также за приготовление к террористическому преступлению",
    5296: "Уголовная ответственность за \"покушение\" на преступление наступает только за покушение на преступление средней тяжести, тяжкое или особо тяжкое преступление, а также за покушение на террористическое преступление",
    5320: "взятки",
    5321: "МРП",
    5322: "час.",
    5323: "ок",
    5324: "до пожизненно",
    5421: "Несовершеннолетним лишение гражданства не назначается",
    5422: "Лицо должно быть гражданином РК, т.к. по этой статье обязательно лишение гражданства",
    5423: "Лишение гражданства обязательно",
    5424: "Возможно лишение гражданства",
    5436: "дохода/ущерба",
}


def setlang(message_id: int, lang: str = "ru") -> str:
    lang = normalize_lang(lang)
    if lang != "ru":
        return str(message_id)
    return _USER_DICT_RU.get(int(message_id), str(message_id))


def _form_i(number: int, form1: str, form2: str, form5: str) -> str:
    n = abs(int(number))
    if 11 <= n % 100 <= 14:
        return form5
    last = n % 10
    if last == 1:
        return form1
    if 2 <= last <= 4:
        return form2
    return form5


def _form_d(number: int, form1: str, form5: str) -> str:
    n = abs(int(number))
    if 11 <= n % 100 <= 14:
        return form5
    last = n % 10
    if last == 1:
        return form1
    return form5


def dmytorus(number: int, unit_type: int, padezh: str) -> str:
    """
    FoxPro DMYTORUS emulation.

    unit_type: 1=days, 2=months, 3=years
    padezh: 'I' (nominative) or 'D' (genitive for ranges)
    """
    padezh = (padezh or "I").upper()
    if unit_type == 1:
        if padezh == "D":
            return _form_d(number, "дня", "дней")
        return _form_i(number, "день", "дня", "дней")
    if unit_type == 2:
        if padezh == "D":
            return _form_d(number, "месяца", "месяцев")
        return _form_i(number, "месяц", "месяца", "месяцев")
    if unit_type == 3:
        if padezh == "D":
            return _form_d(number, "года", "лет")
        return _form_i(number, "год", "года", "лет")
    return ""


def format_number(value: float) -> str:
    """
    Format number similar to FoxPro TRANSFORM usage in count_srk.
    Integers are rendered without decimals, otherwise up to 2 decimals.
    """
    if value is None:
        return "0"
    if float(value).is_integer() and float(value) != 0:
        return str(int(round(float(value))))
    text = f"{float(value):.2f}".rstrip("0").rstrip(".")
    return text or "0"
